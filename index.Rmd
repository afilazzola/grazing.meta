---
title: A meta-analysis fo the multi-trophic effects of grazing
author: ""
date: "2018"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
---
<br>  

### Grazing effects are multi-trophic through mediating plant composition: a meta-analysis
<br>  

![](./grazing.jpg)
<br> 

[Alessandro Filazzola](http://www.filazzola.info/), Batbaatar Amgaa,  Charlotte Brown, Issac Heida, Jessica Grenke, Margarete Dettlaff, Tan Bao, & [JC Cahill](https://grad.biology.ualberta.ca/cahill/)


```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(PRISMAstatement)
```

### Purpose

Conduct a meta-analysis of the literature testing the indirect effects of grazing on animal taxa's through the direct effects on the plant community. 

### Objectives

1. 
2. 

### Timeline

date    | task
------------------|--------------------------------------------------
Nov 9 | Establish search terms to be used in the meta-analysis
Nov 12 | Compile list of journal artcles and sub-divide for each researcher
Nov 14  | Begin reviewing papers and extracting data
Jan 28  | Complete data extraction from papers
Feb 11  | Complete preliminary analysis and set structure for MS
Feb 25 | Settle on analyses to be used and begin writing manuscript
March 11 | Complete first draft of MS and pass to co-authors
March 25 | Comments passed back on draft
April 2 | Complete revisions and submit to journal


### Literature Review - 1. Search

#### Search Terms

A systematic literature search was conducted using Web of Science for all emperical research articles.  The review will include all studies globally. The intended purpose of this search is to capture all articles that have documented grazing either along a gradient (e.g. different frequencies or intensity) or presence/absence (e.g. excluded, ungrazed, or retired ranch lands). We condcuted two separate searches to capture studies that tested gradients and studies that compared grazing to ungrazed treatments. Duplicate articles between the searches were removed. We also intentionally excluded terms that  resulted in articles not relevant to the purpose of this study including: review, synthesis, policy, social, carbon, and fish. The search terms that used were: 

**Search A**
`graz* OR livestock` **AND**  `exclosure* OR exclusion OR exclude* OR ungrazed OR retire* OR fallow*`

**Search B**
`grazing intensity OR grazing gradient OR stocking rate OR rotation* grazing`


### Literature Review - 2. Sort

This steps includes a. checking for duplicating, b. reviewing each instance for relevancy, c. consistently identifying and documenting exclusion criteria. Outcomes include a list of publications to be used for synthesis, a library of pdfs, and a PRISMA report to ensure the worflow is transparent and reproducible. Papers were excluded with the following characteristics:

- Not emperical study (e.g. review, book chapter)
- Irrelevant categories (e.g. political science, law, sports tourism, art)

#### Reasons for exclusion
```{r, warning=FALSE, message=FALSE}
evidence <- read.csv("data//ReviewerSearch//evidence.new.csv")
### Identify studies that were excluded
excludes <- evidence %>% group_by(reason.simplified) %>% count(exclude) %>% filter(reason.simplified!="")
ggplot(excludes, aes(x=reason.simplified, y=n)) + geom_bar(stat="identity") + coord_flip() + xlab("Reason for exclusion")

## frequency of study
year.rate <- evidence %>% group_by(Publication.Year) %>% summarize(n=length(Publication.Year))

ggplot(tail(year.rate,30)) + geom_bar(aes(x=Publication.Year, y=n), stat="identity") + ylab("number of published studies") +xlab("year published") +theme(text = element_text(size=16))
```


#### Prisma report

```{r}
## total number of papers found
nrow(evidence)

## number of papers found outside of WoS
other <- read.csv("data/synthesisdata//other.sources.csv")
nrow(other)

## number of articles excluded
excludes <- evidence %>% filter(exclude=="yes")
nrow(excludes)

## relevant papers
review <- evidence %>% filter(exclude!="yes")
nrow(review)

## papers for meta
datasets <- read.csv("data//binary.simplified.csv")
meta <- length(unique(datasets$uniqueID))
meta

prisma(found = 3485,
       found_other = 4,
       no_dupes = 3489,
       screened = 3489,
       screen_exclusions = 0,
       full_text = 3489,
       full_text_exclusions = 3250,
       qualitative = 239, 
       quantitative = 90,
       width = 800, height = 800)
```



### 3. Synthesis - Abundance

```{r}
meta <- read.csv("data//binary.simplified.csv")


## Load packages and functions
library(reshape2)
library(metafor)
source("meta.evalSE.r") ## Multiple aggregate


## Simplify the estimates column
meta2 <- meta
est <- read.csv("data//Unique.Estimates.Column.csv")
meta2 <- merge(meta2, est, by="Estimate")

## drop Lichen, Microbes and fungi
meta2 <- meta2 %>% filter(Functional.Group != "Producer") %>% filter(Higher.Taxa != "Microbial") ## examine animals only

## join manuscript data
ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
meta2 <- merge(meta2, ms.data, by="uniqueID")
## subset for abundance only
meta2 <- meta2 %>% filter(est.reduced == "diversity")
meta2[,"functional.taxa"] <- paste0(meta2$Higher.Taxa, meta2$Functional.Group)

## Create Unique identifier column
meta2[,"UniqueSite"] <- paste(meta2$uniqueID, meta2$Higher.Taxa, meta2$Taxa, meta2$functional.taxa, meta2$estimate.simplified, sep="-")

## convert se to sd
meta2[meta2$Stat=="sd","Value"] <- meta2[meta2$Stat=="sd","Value"] / sqrt(meta2[meta2$Stat=="sd","replicate"] )
meta2[meta2$Stat=="sd","Stat"] <- "se"

## drop comparisons that are not pairwise
meta2 <-  meta2 %>% filter(grazing.reduced == "ungrazed" | grazing.reduced == "grazed")
meta2 <- meta2 %>% filter(!uniqueID %in% c("30","416")) %>% ## drop study 30 and 416 because anomalous 
  filter(uniqueID != "111") ## data is missing in study 111

## Drop anomalous studies
meta2 <- meta2 <- meta2 %>% filter(!uniqueID %in% c("654", "1660")) ## native grazer not ungulate

## Test one higher taxa at a time
meta2 <- meta2 %>% filter(Functional.Group != "Other")

## Test domestic grazers only
meta2 <- meta2 %>%  filter(grazer.simplified %in% c("domestic","both")) %>% filter(!grazer.spp.reduced == "domestic")

## Use function to extract summary statistics for comparisons
## meta.eval  arguments are (meta.data, compare, ids , stats)
grazed.compare <- meta.eval(meta2, grazing.reduced, UniqueSite, Stat)

## Combine the lists into same dataframe
## Rename Columns in second dataframe
grazed.stat <- grazed.compare [[2]] ## extracted statistics 
names(grazed.stat) <- c("UniqueSite","grazed_mean","grazed_se","ungrazed_mean","ungrazed_se","grazed_n","ungrazed_n") ## rename columns to match
grazed.raw <- grazed.compare[[1]] ## calculated statistics from raw values

## Join two dataframes
meta.stat <- rbind(grazed.raw, grazed.stat[, names(grazed.raw)])

## Calculate effect size from SE rather than SD. To calculate variance treat replicates as 1. 
## https://stats.stackexchange.com/questions/152172/meta-analysis-in-r-with-standard-errors-instead-of-standard-deviations-metafor 
meta.stat[,"dummyN"] <- 1
meta.ready <- escalc(n1i = dummyN, n2i = dummyN, m1i = ungrazed_mean, m2i = grazed_mean, sd1i = ungrazed_se, sd2i = grazed_se, data = meta.stat, measure = "ROM", append = TRUE)
  
  ## clean up meta.ready
  meta.ready <- na.omit(meta.ready) ## drop NAs

  
  ## separate out the identifiers
  siteID <- matrix(unlist(strsplit(meta.ready$UniqueSite,"-")),ncol=5, byrow=TRUE)
  siteID <- data.frame(siteID) ## recreate as dataframe
  colnames(siteID) <- c("Study","higher.taxa","taxa","FG","measure") ## add column names
  meta.ready <- cbind(data.frame(meta.ready), siteID)
  
  #random-effects meta-analysis for grazed vs ungrazed plots
  m1 <- rma(yi=yi, vi=vi,  data = meta.ready)
  summary(m1) 

  
  #mixed-effects meta-analysis for grazed vs ungrazed plots
  m2 <- rma(yi=yi, vi=vi, mods=~ -1 + FG,  data = subset(meta.ready, vi<4), digits=4 )
  summary(m2) 
  
  #The benchmark values for I2 are 25, 50 and 75% for low, moderate and high heterogeneity, respectively (Higgins et al. 2003).
  
  
  ## number of studies per comparison
  nstudies <- meta.ready %>% group_by(FG) %>% summarise(n=length(FG))
  nstudies
  #write.csv(meta.ready, "data//effectSize//div.animal.csv", row.names=FALSE)

## compare inclusion of moderators
(.9539-.9352)/.9352 ## explains an additional 2%

## Produce a forest plot to determine the effect sizes for each study
forest(m2)
regtest(m2)
confint(m1)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m2, ylim=c(1.2,0))

## Calculate rosenthals Failsafe number
fsn(yi, vi, data=meta.ready)



# ## generate plot with spaces inbetween
# forest(m1, atransf=exp, cex=0.75, ylim=c(-1, 24),
#        order=order(meta.ready$GI.compare,meta.ready$taxa), rows=c(3:4,7,10:16,19:21),
# #         mlab="RE model for all studies", psize=1, slab= paste(meta.ready$Study, meta.ready$taxa, meta.ready$measure))
# 
# addpoly(res.w, row=18, cex=0.75, atransf=exp, mlab="RE model for green wall")
# addpoly(res.r, row= 9, cex=0.75, atransf=exp, mlab="RE model for green roof")
# addpoly(res.rd, row= 6, cex=0.75, atransf=exp, mlab="RE model for roadsides")
# addpoly(res.p, row= 2, cex=0.75, atransf=exp, mlab="RE model for retention ponds")

```

### Create Appendix A
``` {r}
meta <- read.csv("data//binary.simplified.csv")


## Load packages and functions
library(reshape2)
library(metafor)
source("meta.evalSE.r") ## Multiple aggregate


## Simplify the estimates column
meta2 <- meta
est <- read.csv("data//Unique.Estimates.Column.csv")
meta2 <- merge(meta2, est, by="Estimate")

## drop duplicates
ests <- meta2[!duplicated(meta2[,c(1,21:22)]),c(1,21:22)]
ests.used <- ests %>% filter(!est.reduced %in% c("omit", "behavioural","fitness")) ## filter only the variables used

## write estimates
write.csv(ests.used, "data//appendixA.csv", row.names = F)
```


### Animal comparisons
```{r}
meta.ready <- read.csv("abundanceEff.csv")
  
  #random-effects meta-analysis for grazed vs ungrazed plots
  m1 <- rma(yi=yi, vi=vi,  data = meta.ready)
  summary(m1) 

  
  #mixed-effects meta-analysis for grazed vs ungrazed plots
  m2 <- rma(yi=yi, vi=vi, mods=~ -1 + FG,  data = subset(meta.ready, vi<4), digits=4 )
  summary(m2) 

### Bias tests  
regtest(m2)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m2, ylim=c(1.2,0))

## Calculate rosenthals Failsafe number
fsn(yi, vi, data=meta.ready)

  
  meta.ready <- read.csv("diversityEff.csv")
  
  #random-effects meta-analysis for grazed vs ungrazed plots
  m1 <- rma(yi=yi, vi=vi,  data = meta.ready)
  summary(m1) 

  
  #mixed-effects meta-analysis for grazed vs ungrazed plots
  m2 <- rma(yi=yi, vi=vi, mods=~ -1 + FG,  data = subset(meta.ready, vi<4), digits=4 )
  summary(m2) 
  
  ### Bias tests  
regtest(m2)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m2, ylim=c(0.8,0))

## Calculate rosenthals Failsafe number
fsn(yi, vi, data=meta.ready)
```

### Testing the effects of grazing on producers
```{r}
meta <- read.csv("data//plantAnalysis.csv")
meta2 <- meta
  
## Load packages and functions
library(reshape2)
library(metafor)
source("meta.evalSE.r") ## Multiple aggregate
  
  
  
  ## join manuscript data
  ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
  meta2 <- merge(meta2, ms.data, by="uniqueID")

  ## Drop mychoriza because only two studies
  
    ## Create Unique identifier column
  meta2 <- meta2 %>% filter(estimate.simplified != "omit")
  meta2[,"UniqueSite"] <- paste(meta2$uniqueID, meta2$Taxa, meta2$estimate.simplified, sep="-")
  
  ## convert se to sd
   meta2[meta2$Stat=="sd","Value"] <- meta2[meta2$Stat=="sd","Value"] / sqrt(meta2[meta2$Stat=="sd","replicate"] )
   meta2[meta2$Stat=="sd","Stat"] <- "se"
  
  ## drop comparisons that are not pairwise
  meta2 <-  meta2 %>% filter(grazing.reduced == "ungrazed" | grazing.reduced == "grazed")
  meta2 <- meta2 %>% filter(uniqueID != "30") ## drop study 30 because anomalous 
  
  ## Drop anomalous studies
  meta2 <- meta2 <- meta2 %>% filter(!uniqueID %in% c("654", "1660")) ## native grazer not ungulate
  meta2 <- meta2 %>% filter(estimate.simplified != "fitness") ## drop fitness because only study 

  ## Test domestic grazers only
  meta2 <- meta2 %>% filter(grazer.simplified %in% c("domestic","both")) %>% 
    filter(grazer.spp.reduced != "domestic") ## select only sheep and cattle comparisons


    ## Use function to extract summary statistics for comparisons
  ## meta.eval  arguments are (meta.data, compare, ids , stats)
  grazed.compare <- meta.eval(meta2, grazing.reduced, UniqueSite, Stat)
  
  ## Combine the lists into same dataframe
  ## Rename Columns in second dataframe
  grazed.stat <- grazed.compare [[2]] ## extracted statistics 
  names(grazed.stat) <- c("UniqueSite","grazed_mean","grazed_se","ungrazed_mean","ungrazed_se","grazed_n","ungrazed_n") ## rename columns to match
  grazed.raw <- grazed.compare[[1]] ## calculated statistics from raw values
  
  ## Join two dataframes
  meta.stat <- rbind(grazed.raw, grazed.stat[, names(grazed.raw)])
  
  
## Calculate effect size from SE rather than SD. To calculate variance treat replicates as 1. 
## https://stats.stackexchange.com/questions/152172/meta-analysis-in-r-with-standard-errors-instead-of-standard-deviations-metafor 
meta.stat[,"dummyN"] <- 1
meta.ready <- escalc(n1i = dummyN, n2i = dummyN, m1i = ungrazed_mean, m2i = grazed_mean, sd1i = ungrazed_se, sd2i = grazed_se, data = meta.stat, measure = "ROM", append = TRUE)
  
  ## clean up meta.ready
  meta.ready <- na.omit(meta.ready) ## drop NAs

  
  ## separate out the identifiers
  siteID <- matrix(unlist(strsplit(meta.ready$UniqueSite,"-")),ncol=3, byrow=TRUE)
  siteID <- data.frame(siteID) ## recreate as dataframe
  colnames(siteID) <- c("Study","taxa","measure") ## add column names
  meta.ready <- cbind(data.frame(meta.ready), siteID)
  
  #random-effects meta-analysis for grazed vs ungrazed plots
  m1 <- rma(yi=yi, vi=vi,  data = meta.ready)
  summary(m1) 
  
  ## get last year grazed as covariate
  yr.grazed <- meta2 %>% group_by(uniqueID) %>% summarize(yr=max(yr.grazed))
  colnames(yr.grazed)[1] <- "Study"
  site.yr <- merge(siteID, yr.grazed, by="Study")
  meta.ready[,"yr.grazed"] <- site.yr$yr
  meta.ready[,"previously.grazed"] <- as.factor(ifelse(is.na(meta.ready$yr.grazed),0,1))
  
  #mixed-effects meta-analysis for grazed vs ungrazed plots
  m2 <- rma(yi=yi, vi=vi, mods=~ -1 + measure ,  data = subset(meta.ready, vi!=0))
  summary(m2) 
  
  
  ## number of studies
  meta.ready %>% group_by(measure) %>% summarize(n=length(measure))
  
  fsn(yi, vi, data=meta.ready)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m2)
regtest(m2)


## write
write.csv(subset(meta.ready, vi<4), "plantEff.csv", row.names=F)
```

### Separated Plant responses
```{r}
plt <- read.csv("plantEff.csv")
# animal.abd <- subset(animal.abd, measure=="diversity" & vi!=0) ## one measure at a time for plants
colnames(plt)[colnames(plt)=="Study"] <- "uniqueID"
 
## join manuscript data
ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
meta3 <- merge(plt, ms.data, by="uniqueID")
meta3[,c("yi")] <- meta3[,c("yi")] ## inverse effect
meta3[,"yr.grazed"] <- meta3$last.grazing.event

meta.ready <- meta3[!is.na(meta3$yr.grazed),]
meta.ready$yr.grazed <- as.numeric(meta.ready$yr.grazed)

## abundance
m1 <- rma(yi=yi, vi=vi, data = subset(meta.ready, measure == "abundance" & vi!=0))
summary(m1) 


  ### Bias tests  
regtest(m1)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m1, ylim=c(0.8,0))

## time-since-grazed
m1.tsg <- rma(yi=yi, vi=vi,  mods=~ yr.grazed, data = subset(meta.ready, measure == "abundance" & vi!=0))
summary(m1.tsg) 

## richness
m2 <- rma(yi=yi, vi=vi, data = subset(meta.ready, measure == "diversity"& vi!=0))
summary(m2) 


  ### Bias tests  
regtest(m2)


## Check for publication bias
## The symetrical distriubtion suggests there is no publication bias
funnel(m2, ylim=c(0.8,0))

## time-since-grazed
m2.tsg <- rma(yi=yi, vi=vi, mods=~ poly(yr.grazed,2) , data = subset(meta.ready, measure == "diversity" & vi!=0))
summary(m2.tsg)

preds <- predict(m2.tsg, yr.grazed=meta.ready$yr.grazed)

### plants
ggplot(subset(meta.ready, measure == "abundance" & vi!=0), aes(x=yr.grazed, y=yi))+ geom_hline(yintercept=0, lwd=1, lty=2)+ geom_jitter(size=4) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=16)) + xlab("Time since exclusion (yrs)") + ylab("Effect of livestock exclusion (LRR)")+ 
  annotate("text", x=32, y=2.2, label="plant abundance", size=6) + 
  geom_line( aes(x=yr.grazed, y=preds$pred), lwd=1) +
geom_ribbon(aes(x=yr.grazed,ymin=preds$ci.lb, ymax=preds$ci.ub), alpha=0.2) + scale_color_manual(values=cbPalette) 

```


### Trends among studies
```{r}
## load metadata of manuscripts
 ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
ms.data[is.na(ms.data)] <- 0

## load effect sizes from each model 
div <- read.csv("diversityEff.csv")
abd <- read.csv("abundanceEff.csv")
plt <- read.csv("plantEff.csv")

## list unique studies
studies <- c(div$Study, abd$Study, plt$Study)
studies <- studies[!duplicated(studies)]

## select only used studies
msUsed <- ms.data[ms.data$uniqueID %in% studies,]


## Taxa that was examined
apply(msUsed[,21:29], 2, sum)

## Which grazer
 msUsed %>% group_by(grazer.spp.reduced) %>% summarize(n=length(grazer.spp.reduced))
 
 ##indigenous grazers
 msUsed %>% group_by(indigenous.simplified
) %>% summarize(n=length(indigenous.simplified))
 
 
 
 ### compare effect sizes by joining studies together
 effdata <- rbind(data.frame(uniqueID=div$Study, yi=div$yi, vi=div$vi),data.frame(uniqueID=abd$Study, yi=abd$yi, vi=abd$vi),data.frame(uniqueID=plt$Study, yi=plt$yi, vi=plt$vi))
 
 effdata <- merge(effdata, msUsed, by="uniqueID")
 
 ## compare grazer spp to eff size
 kruskal.test(yi ~ grazer.spp.reduced, data = effdata)
 
 

  m2 <- rma(yi=yi, vi=vi, mods=~  grazer.spp.reduced ,  data = subset(effdata, vi!=0))
  summary(m2) 
 
 ## compare grazer to history
 hist <- effdata %>% filter(indigenous.simplified %in% c("none","co-occurring","historic"))
 
kruskal.test(yi ~ indigenous.simplified, data = hist)
```


#### Patterns of Grazing Studies Globally
```{r warning=FALSE, message=FALSE, fig.width=12, fig.height=10}
require(ggmap)
###  Start with base map of world
mp <- NULL
mapWorld <- borders("world", colour="gray50", fill="gray50") # create a layer of borders
mp <- ggplot() +   mapWorld

## colorblind-friendly palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7","#000000")


msUsed <- msUsed %>% filter(lat != "") ## remove blanks for lat and lon
msUsed$lat <- as.numeric(levels(msUsed$lat))[msUsed$lat] ## convert from factor to number
msUsed$lon <- as.numeric(levels(msUsed$lon))[msUsed$lon] ## convert from factor to number


## plot points on top
mp <- mp+ geom_point(data=msUsed , aes(x=lon, y=lat), size=2) 
mp

unique(msUsed$grazer.spp.reduced)

msUsed[msUsed$grazer.spp.reduced=="domestic",]


## figure out country from GPS

names <- map.where(database="world", msUsed$lon, msUsed$lat)
## separate subcountry identifiers
country <- gsub("?:.*", "", names)
length(unique(country))

table(country)

## extract climate

koppen <- read.table("data//KoppenClimate.txt", header=T)
koppen[,"location"] <- paste(koppen$Lat, koppen$Lon, sep="-")
msUsed[,"location"] <- paste(msUsed$lat, msUsed$lon, sep="-")

ClosestMatch2 = function(string, stringVector){

  stringVector[stringdist::amatch(string, stringVector, maxDist=Inf)]

}

climID <- ClosestMatch2(msUsed$location, koppen$location)
climNames <- merge(data.frame(location=climID), koppen, by.x="location")

## list climates
climNames %>% group_by(Cls) %>% summarize(n=length(Cls))
climNames[,"location"] <- as.character(climNames[,"location"] ) 
names(climNames)[2:3] <- c("lat","lon")

## Drop anomalous point
climNames <- subset(climNames, lat > -80)

## More broad groupings
climNames["group"] <- substr(climNames$Cls, 1, 1)
climgroups <- data.frame(group=c("A","B","C","D"), climate=c("Tropical","Arid/Semi-arid","Temperate","Continental"))
climNames <- merge(climNames, climgroups, by="group")



cbPalette <- c( "#D55E00", "#56B4E9", "#0072B2", "#009E73", "#F0E442", "#E69F00", "#CC79A7","#000000","#999999")

## map with climate
mp + geom_point(data=msUsed , aes(x=lon, y=lat, col=grazer.spp.reduced ), size=2)  + xlab("Longitude") + ylab("Latitude") + xlim(-180, 180) + ylim(-90,90)+  scale_color_manual(values = cbPalette, name = "Grazer composition")



```


### Compare regional patterns
```{r}
## Load in effect sizes
occurdat<-list.files( pattern="Eff.csv$",full=T)
animal.abd <- read.csv(occurdat[2])
# animal.abd <- subset(animal.abd, measure=="diversity" & vi!=0) ## one measure at a time for plants
colnames(animal.abd)[colnames(animal.abd)=="Study"] <- "uniqueID"
 
## join manuscript data
ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
meta3 <- merge(animal.abd, ms.data, by="uniqueID")
meta3[,c("yi")] <- meta3[,c("yi")]*-1 ## inverse effect

library(raster)
# 
# ## Convert lat lon to spatial points
# meta3 <- meta3 %>% filter(lat != "") ## remove blanks for lat and lon
# meta3 <- meta3[!grepl(";", meta3$lat),] ## remove multiple entries
# meta3$lat <- as.numeric(levels(meta3$lat))[meta3$lat] ## convert from factor to number
# meta3$lon <- as.numeric(levels(meta3$lon))[meta3$lon] ## convert from factor to number
# 
# ## generate dataframe
# gps <- data.frame(uniqueID = meta3$uniqueID, lon=meta3$lon, lat=meta3$lat)
# gps <- gps[!duplicated(gps$uniqueID),]
# 
# 
# ## assign spatial points
# crs.world <-CRS("+proj=longlat +datum=WGS84")
# coordinates(gps) <- ~lon+lat
# proj4string(gps) <- crs.world
# 
# ## load rasters
# temp <- raster("C:\\Users\\Fitz\\Downloads\\bioclim2\\bio01.tif")
# prec <- raster("C:\\Users\\Fitz\\Downloads\\bioclim2\\bio12.tif")
# 
# temp2 <- temp
# 
# clim <- stack(temp,prec)
# 
# 
# ## extract temperature and preciptiation
# gps.clim <- data.frame(raster::extract(clim, gps))
# gps.clim["uniqueID"] <- gps$uniqueID


## get CRU data
CRU <- read.csv("data//climateCRU.csv")
CRU <- na.omit(CRU)

## compare climate & grazing duration variables against effect size


## get last year grazed as covariate
meta.ready <- merge(meta3, CRU, by="uniqueID")

### Temperature only
#mixed-effects meta-analysis for grazed vs ungrazed plots
m3 <- rma(yi=yi, vi=vi, mods=~ poly(temp,1) * poly(precip,1),  data = meta.ready)
summary(m3) 


## line
preds <- predict(m3, temp=meta.ready$temp)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#D55E00", "#0072B2","#000000")

## generate column for FG
meta.ready[,"trophic"] <- gsub("^.*?ertebrate","",meta.ready$FG)

### Plot against temperature
ggplot(meta.ready, aes(x=temp, y=yi))+ geom_hline(yintercept=0, lwd=1, lty=2)+ geom_jitter(aes(color=trophic, shape=higher.taxa), size=4) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=16)) + xlab("Temperature (°C)") + ylab("Effect of grazing relative to control (LRR)") + geom_line(data=data.frame(preds), aes(x=meta.ready$temp, y=pred), lwd=2) +
geom_ribbon(data=data.frame(preds), aes(x=meta.ready$temp, y=pred, ymin=ci.lb, ymax=ci.ub), alpha=0.2) + scale_color_manual(values=cbPalette)+xlim(0,20)


### Preciptiation

test <- subset(meta.ready, FG == "VertebrateHerbivorous" | FG == "InvertebrateHerbivorous")

#mixed-effects meta-analysis for grazed vs ungrazed plots
m4 <- rma(yi=yi, vi=vi, mods=~ poly(precip,2),  data = subset(meta.ready))
summary(m4) 


## line
preds <- predict(m4, precip=meta.ready$precip)


### Plot against temperature
ggplot(meta.ready, aes(x=precip, y=yi))+ geom_hline(yintercept=0, lwd=1, lty=2)+ geom_jitter(aes(color=trophic, shape=higher.taxa),size=4) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=16)) + xlab("Mean annual preciptiation (mm)") + ylab("Effect of grazing relative to control (LRR)") + scale_color_manual(values=cbPalette) + 
  geom_line(data=data.frame(preds), aes(x=meta.ready$precip, y=pred), lwd=2) +
geom_ribbon(data=data.frame(preds), aes(x=meta.ready$precip, y=pred, ymin=ci.lb, ymax=ci.ub), alpha=0.2) 



test <- meta.ready[!is.infinite(meta.ready$aridity),]

m4 <- rma(yi=yi, vi=vi, mods=~ poly(log(aridity),2),  data = test)
summary(m4) 

preds <- predict(m4, aridity=test$aridity)


### Plot against aridity
ggplot(test, aes(x=aridity, y=yi))+ geom_hline(yintercept=0, lwd=1, lty=2)+ geom_jitter(aes(color=trophic, shape=higher.taxa),size=4) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=16)) + xlab("Mean annual preciptiation (mm)") + ylab("Effect of grazing relative to control (LRR)") + geom_line(data=data.frame(preds), aes(x=test$aridity, y=pred), lwd=2) +
geom_ribbon(data=data.frame(preds), aes(x=test$aridity, y=pred, ymin=ci.lb, ymax=ci.ub), alpha=0.2) + scale_color_manual(values=cbPalette)


## Time since grazed Grazed

## Load in effect sizes
occurdat<-list.files( pattern="Eff.csv$",full=T)
animal.abd <- read.csv(occurdat[2])
colnames(animal.abd)[colnames(animal.abd)=="Study"] <- "uniqueID"
 
## join manuscript data
ms.data <- read.csv("data//synthesisdata//manuscript.revised.csv")
meta3 <- merge(animal.abd, ms.data, by="uniqueID")
meta3$last.grazing.event <- as.numeric(meta3$last.grazing.event)
meta3[,c("yi")] <- meta3[,c("yi")]
meta3[,"yr.grazed"] <- meta3$last.grazing.event

## compare climate & grazing duration variables against effect size

## get last year grazed as covariate
meta.ready <- subset(meta3, yr.grazed>0& yr.grazed < 60)


#mixed-effects meta-analysis for grazed vs ungrazed plots
m3 <- rma(yi=yi, vi=vi, mods=~  poly(yr.grazed,2),  data = meta.ready)
summary(m3) 


## generate column for FG
meta.ready[,"trophic"] <- gsub("^.*?ertebrate","",meta.ready$FG)


## line
preds <- predict(m3, yr.grazed=meta.ready$yr.grazed)

# cbPalette <- c("#77564C", "#4381C1", "#9AD4D6", "#4FB286", "#564787", "#08415C")

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#D55E00", "#0072B2","#000000")


## animals
ggplot(meta.ready, aes(x=yr.grazed, y=yi))+ geom_hline(yintercept=0, lwd=1, lty=2)+ geom_jitter(aes(color=trophic, shape=higher.taxa), size=4, width=1) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), text = element_text(size=16)) + xlab("Time since exclusion (yrs)") + ylab("Effect of livestock exclusion (LRR)") + geom_line(data=data.frame(preds), aes(x=meta.ready$yr.grazed, y=pred), lwd=1) +
geom_ribbon(data=data.frame(preds), aes(x=meta.ready$yr.grazed, y=pred, ymin=ci.lb, ymax=ci.ub), alpha=0.2) + scale_color_manual(values=cbPalette)+ 
  annotate("text", x=32, y=1, label="animal diversity", size=6)



### Old figure
# ### calculate predicted risk ratios for full grazing time gradient
# preds <- predict(m3, newmods=c(0:35), transf=exp)
# 
# ### radius of points will be proportional to the inverse standard errors
# ### hence the area of the points will be proportional to inverse variances
# size <- 1 / sqrt(meta.ready$vi)
# size <- size / max(size) *0.95
# 
# ### set up plot (risk ratios on y-axis, absolute temperature on x-axis)
# plot(NA, NA, xlim=c(0,35), ylim=c(0.5,5),
#      xlab="Year since control was last grazed", ylab="Effect of grazing relative to control (LRR)",
#      las=1, bty="l", log="y", cex.lab=1.5, cex.axis=1.2)
# 
# ### add points
# col <- data.frame(FG=unique(meta.ready$FG), colors= c("#999999","#E69F00", "#56B4E9", "#D55E00","#0072B2","#E69F00","#0072B2"))
# ptshape <- data.frame(FG=unique(meta.ready$FG), shape= c(21,21,21,21,21,23,23))
# meta.ready <- merge(meta.ready, col, by="FG")
# meta.ready <- merge(meta.ready, ptshape, by="FG")
# points(meta.ready$yr.grazed, exp(meta.ready$yi), pch=meta.ready$shape, bg=as.character(meta.ready$colors), cex=2)
# arrows(meta.ready$yr.grazed, exp(meta.ready$yi)-meta.ready$vi, ## lower
#        meta.ready$yr.grazed, exp(meta.ready$yi)+meta.ready$vi, ## upper
#        length=0.05, angle=90, code=3)
# 
# # symbols(meta.ready$yr.grazed, exp(meta.ready$yi), circles=size, inches=FALSE, add=TRUE, bg=as.character(meta.ready$colors))
# 
# legend(0,5.5, legend=col$FG, pt.bg=as.character(col$colors), pch=meta.ready$shape, cex=0.8)
#                    
# ### add predicted values (and corresponding CI bounds)
# lines(0:35, preds$pred, lwd=2)
# lines(0:35, preds$ci.lb, lty="dashed")
# lines(0:35, preds$ci.ub, lty="dashed") 
```

### Taxa that are tested
```{r}

### Load main data
meta <- read.csv("data//binary.simplified.csv")

## load studies used
div <- read.csv("diversityEff.csv")
abd <- read.csv("abundanceEff.csv")

studiesUsed <- c(div$Study, abd$Study)
dataused <- meta %>% filter(uniqueID %in% studiesUsed)

## count taxa 
taxa <- dataused %>% group_by(Taxa) %>% summarize(n=length(unique(uniqueID)))
taxa

## unique studies
length(unique(studiesUsed))
